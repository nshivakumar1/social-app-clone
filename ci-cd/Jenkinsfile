pipeline {
    agent any
    
    environment {
        ECR_REGISTRY = '297997106614.dkr.ecr.us-east-1.amazonaws.com'
        ECR_REPOSITORY = 'social-app-clone'
        AWS_REGION = 'us-east-1'
        ECS_CLUSTER = 'social-app-clone'
        ECS_SERVICE = 'social-app-clone'
        IMAGE_TAG = "${BUILD_NUMBER}"
    }
    
    stages {
        stage('ðŸ” Checkout') {
            steps {
                script {
                    echo "ðŸ“¥ Checking out code from GitHub..."
                    checkout scm
                    env.COMMIT_SHA = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.COMMIT_MESSAGE = sh(script: 'git log -1 --pretty=format:%s', returnStdout: true).trim()
                    echo "ðŸ“ Commit: ${env.COMMIT_SHA} - ${env.COMMIT_MESSAGE}"
                }
            }
        }
        
        stage('ðŸ§ª Test') {
            steps {
                script {
                    echo "ðŸ§ª Running tests..."
                    dir('app') {
                        sh 'echo "âœ… Tests passed (placeholder)"'
                    }
                }
            }
        }
        
        stage('ðŸ‹ Build Docker Image') {
            steps {
                script {
                    echo "ðŸ”¨ Building Docker image..."
                    dir('app') {
                        sh "docker build --platform linux/amd64 -t ${ECR_REPOSITORY}:${IMAGE_TAG} ."
                        sh "docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REPOSITORY}:latest"
                        sh "docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REPOSITORY}:${env.COMMIT_SHA}"
                    }
                    echo "âœ… Docker image built successfully"
                }
            }
        }
        
        stage('ðŸ“¤ Push to ECR') {
            steps {
                script {
                    withCredentials([aws(credentialsId: 'aws-credentials')]) {
                        sh "echo 'ðŸ” Logging into ECR...'"
                        sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}"
                        
                        sh "echo 'ðŸ“¤ Pushing images to ECR...'"
                        sh "docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
                        sh "docker tag ${ECR_REPOSITORY}:latest ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"
                        sh "docker tag ${ECR_REPOSITORY}:${env.COMMIT_SHA} ${ECR_REGISTRY}/${ECR_REPOSITORY}:${env.COMMIT_SHA}"
                        
                        sh "docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
                        sh "docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"
                        sh "docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${env.COMMIT_SHA}"
                        
                        sh "echo 'âœ… Images pushed successfully'"
                    }
                }
            }
        }
        
        stage('ðŸš€ Deploy to ECS') {
            steps {
                script {
                    withCredentials([aws(credentialsId: 'aws-credentials')]) {
                        sh "echo 'ðŸš€ Deploying to ECS Fargate...'"
                        sh "aws ecs update-service --cluster ${ECS_CLUSTER} --service ${ECS_SERVICE} --force-new-deployment --region ${AWS_REGION}"
                        sh "echo 'â³ Waiting for ECS deployment to stabilize...'"
                        sh "aws ecs wait services-stable --cluster ${ECS_CLUSTER} --services ${ECS_SERVICE} --region ${AWS_REGION} --cli-read-timeout 300 --cli-connect-timeout 60"
                        sh "echo 'âœ… ECS deployment completed'"
                    }
                }
            }
        }
        
        stage('ðŸ“ Update GitOps Manifests') {
            steps {
                script {
                    try {
                        sh "echo 'ðŸ“ Creating Kubernetes manifests...'"
                        sh "mkdir -p k8s-manifests"
                        
                        sh """
cat > k8s-manifests/deployment.yaml << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: social-app-clone
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: social-app-clone
  template:
    metadata:
      labels:
        app: social-app-clone
    spec:
      containers:
      - name: social-app-clone
        image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
---
apiVersion: v1
kind: Service
metadata:
  name: social-app-clone-service
spec:
  selector:
    app: social-app-clone
  ports:
  - port: 80
    targetPort: 3000
  type: LoadBalancer
EOF
                        """
                        
                        echo "âœ… GitOps manifests created"
                    } catch (Exception e) {
                        echo "âš ï¸ GitOps update failed: ${e.getMessage()}"
                        echo "ðŸ”„ Continuing with deployment..."
                    }
                }
            }
        }
        
        stage('ðŸ”„ ArgoCD Sync') {
            steps {
                script {
                    try {
                        sh "echo 'ðŸ”„ Checking ArgoCD configuration...'"
                        sh 'kubectl get applications -n argocd || echo "ArgoCD not configured, skipping sync"'
                        echo "âœ… ArgoCD check completed"
                    } catch (Exception e) {
                        echo "âš ï¸ ArgoCD not available: ${e.getMessage()}"
                        echo "ðŸ“ Kubernetes manifests are available in k8s-manifests/ folder"
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                sh "docker rmi ${ECR_REPOSITORY}:${IMAGE_TAG} || true"
                sh "docker rmi ${ECR_REPOSITORY}:latest || true"
                sh "docker rmi ${ECR_REPOSITORY}:${env.COMMIT_SHA} || true"
                cleanWs()
            }
        }
        
        success {
            script {
                echo """
                ðŸŽ‰ DEPLOYMENT SUCCESSFUL!
                ========================
                âœ… Build: ${IMAGE_TAG}
                âœ… Commit: ${env.COMMIT_SHA}
                âœ… Image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                âœ… ECS: http://social-app-clone-1321601292.us-east-1.elb.amazonaws.com
                âœ… Message: ${env.COMMIT_MESSAGE}
                
                ðŸš€ Your social media app is live and updated!
                """
            }
        }
        
        failure {
            script {
                echo """
                ðŸš¨ DEPLOYMENT FAILED!
                =====================
                âŒ Build: ${BUILD_NUMBER}
                âŒ Commit: ${env.COMMIT_SHA}
                âŒ Message: ${env.COMMIT_MESSAGE}
                
                ðŸ“‹ Check the build logs for details
                """
            }
        }
    }
}